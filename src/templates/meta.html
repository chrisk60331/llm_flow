{% extends "base.html" %}

{% block title %}Meta-Learning - AIP-C01 Prep{% endblock %}

{% block content %}
<div class="mb-6">
    <h1 class="text-2xl font-bold text-gray-900 dark:text-gray-100">Meta-Learning Dashboard</h1>
    <p class="text-gray-600 dark:text-gray-400">Predict and optimize model performance before training</p>
</div>

<!-- Quick Actions -->
<div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
    <div class="metric-card">
        <div class="metric-label">Meta Features</div>
        <div class="metric-value">{{ meta_features_count }}</div>
    </div>
    <div class="metric-card">
        <div class="metric-label">Synthetic Features</div>
        <div class="metric-value">{{ synthetic_count }}</div>
    </div>
    <div class="metric-card">
        <div class="metric-label">Real Features</div>
        <div class="metric-value">{{ real_count }}</div>
    </div>
    <div class="metric-card">
        <div class="metric-label">Predictor Status</div>
        <div class="text-lg font-semibold {% if predictor_trained %}text-emerald-600 dark:text-emerald-400{% else %}text-gray-400{% endif %}">
            {{ 'Trained' if predictor_trained else 'Not Trained' }}
        </div>
    </div>
</div>

<!-- Actions Row -->
<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
    <!-- Generate Synthetic -->
    <div class="section-card">
        <div class="section-header">
            <svg class="w-5 h-5 text-purple-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.387-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z"></path></svg>
            <h3 class="section-title">Generate Synthetic Data</h3>
        </div>
        <div class="section-body">
            <p class="text-sm text-gray-600 dark:text-gray-400 mb-4">Bootstrap the predictor with synthetic training data based on domain knowledge.</p>
            <form action="/meta/generate-synthetic" method="post" class="flex gap-2">
                <input type="number" name="n_samples" value="100" min="10" max="500" class="form-input w-24">
                <button type="submit" class="btn-primary">Generate</button>
            </form>
        </div>
    </div>
    
    <!-- Train Predictor -->
    <div class="section-card">
        <div class="section-header">
            <svg class="w-5 h-5 text-emerald-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path></svg>
            <h3 class="section-title">Train Predictor</h3>
        </div>
        <div class="section-body">
            <p class="text-sm text-gray-600 dark:text-gray-400 mb-4">Train GBM predictor on stored meta-features ({{ meta_features_count }} available).</p>
            <form action="/meta/train" method="post">
                <label class="flex items-center gap-2 mb-3">
                    <input type="checkbox" name="include_synthetic" checked class="form-checkbox">
                    <span class="text-sm text-gray-700 dark:text-gray-300">Include synthetic data</span>
                </label>
                <button type="submit" class="btn-success" {% if meta_features_count < 5 %}disabled title="Need 5+ features"{% endif %}>Train Predictor</button>
            </form>
        </div>
    </div>
    
    <!-- Clear Synthetic -->
    <div class="section-card">
        <div class="section-header">
            <svg class="w-5 h-5 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
            <h3 class="section-title">Clear Synthetic Data</h3>
        </div>
        <div class="section-body">
            <p class="text-sm text-gray-600 dark:text-gray-400 mb-4">Remove all synthetic features from storage. Keep only real experiment data.</p>
            <form action="/meta/clear-synthetic" method="post" onsubmit="return confirm('Remove all synthetic features?')">
                <button type="submit" class="btn-danger">Clear Synthetic</button>
            </form>
        </div>
    </div>
    
    <!-- Backfill ROUGE -->
    <div class="section-card">
        <div class="section-header">
            <svg class="w-5 h-5 text-amber-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg>
            <h3 class="section-title">Backfill ROUGE-L</h3>
        </div>
        <div class="section-body">
            <p class="text-sm text-gray-600 dark:text-gray-400 mb-4">Populate missing ROUGE-L scores from existing benchmark evaluations.</p>
            <form action="/meta/backfill-rouge" method="post">
                <button type="submit" class="btn-primary">Backfill Scores</button>
            </form>
        </div>
    </div>
</div>

<!-- AutoTune Section -->
<div class="section-card mb-6">
    <div class="section-header">
        <svg class="w-5 h-5 text-violet-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>
        <h3 class="section-title">AutoTune Jobs</h3>
    </div>
    <div class="section-body">
        {% if autotune_jobs %}
        <div class="overflow-x-auto">
            <table class="w-full text-sm">
                <thead>
                    <tr class="bg-gray-50 dark:bg-gray-700">
                        <th class="px-3 py-2 text-left text-xs font-semibold text-gray-600 dark:text-gray-400">Job ID</th>
                        <th class="px-3 py-2 text-left text-xs font-semibold text-gray-600 dark:text-gray-400">Status</th>
                        <th class="px-3 py-2 text-left text-xs font-semibold text-gray-600 dark:text-gray-400">Phase</th>
                        <th class="px-3 py-2 text-left text-xs font-semibold text-gray-600 dark:text-gray-400">Started</th>
                        <th class="px-3 py-2 text-right text-xs font-semibold text-gray-600 dark:text-gray-400">Actions</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-gray-100 dark:divide-gray-700">
                    {% for job in autotune_jobs %}
                    <tr class="hover:bg-gray-50 dark:hover:bg-gray-700">
                        <td class="px-3 py-2 font-mono">{{ job.id[:8] }}...</td>
                        <td class="px-3 py-2">
                            {% if job.status == 'completed' %}
                            <span class="badge badge-green">completed</span>
                            {% elif job.status == 'failed' %}
                            <span class="badge badge-red">failed</span>
                            {% else %}
                            <span class="badge badge-blue">{{ job.status }}</span>
                            {% endif %}
                        </td>
                        <td class="px-3 py-2 text-gray-600 dark:text-gray-400">{{ job.phase_message or job.status }}</td>
                        <td class="px-3 py-2 text-gray-500 dark:text-gray-400"><span data-utc="{{ job.started_at }}">{{ job.started_at }}</span></td>
                        <td class="px-3 py-2 text-right">
                            <a href="/evaluations" class="text-sm text-primary-600 hover:text-primary-800">View Results</a>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <p class="text-gray-500 dark:text-gray-400 text-center py-8">No AutoTune jobs yet. Use the AutoTune feature from the home page.</p>
        {% endif %}
    </div>
</div>

<!-- Meta Features List -->
<div class="section-card">
    <div class="section-header">
        <svg class="w-5 h-5 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17V7m0 10a2 2 0 01-2 2H5a2 2 0 01-2-2V7a2 2 0 012-2h2a2 2 0 012 2m0 10a2 2 0 002 2h2a2 2 0 002-2M9 7a2 2 0 012-2h2a2 2 0 012 2m0 10V7m0 10a2 2 0 002 2h2a2 2 0 002-2V7a2 2 0 00-2-2h-2a2 2 0 00-2 2"></path></svg>
        <h3 class="section-title">Meta Features</h3>
    </div>
    <div class="section-body">
        {% if meta_features %}
        <!-- Filters -->
        <div class="grid grid-cols-2 md:grid-cols-5 gap-2 mb-4">
            <div>
                <label class="form-label text-xs">Type</label>
                <select id="filter-type" class="form-select text-sm w-full" onchange="applyMetaFilters()">
                    <option value="">All</option>
                    <option value="synthetic">Synthetic</option>
                    <option value="real">Real</option>
                </select>
            </div>
            <div>
                <label class="form-label text-xs">Learning Rate</label>
                <select id="filter-lr" class="form-select text-sm w-full" onchange="applyMetaFilters()">
                    <option value="">All</option>
                </select>
            </div>
            <div>
                <label class="form-label text-xs">LoRA r</label>
                <select id="filter-lora" class="form-select text-sm w-full" onchange="applyMetaFilters()">
                    <option value="">All</option>
                </select>
            </div>
            <div>
                <label class="form-label text-xs">Model</label>
                <select id="filter-model" class="form-select text-sm w-full" onchange="applyMetaFilters()">
                    <option value="">All</option>
                </select>
            </div>
            <div>
                <label class="form-label text-xs">Batch Size</label>
                <select id="filter-batch" class="form-select text-sm w-full" onchange="applyMetaFilters()">
                    <option value="">All</option>
                </select>
            </div>
        </div>
        <div class="overflow-x-auto">
            <table id="meta-features-table" class="w-full text-sm">
                <thead>
                    <tr class="bg-gray-50 dark:bg-gray-700">
                        <th class="px-3 py-2 text-left text-xs font-semibold text-gray-600 dark:text-gray-400 cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-600" onclick="sortMetaTable(0, 'string')">
                            <div class="flex items-center gap-1">Experiment ID <span class="sort-icon">↕</span></div>
                        </th>
                        <th class="px-3 py-2 text-center text-xs font-semibold text-gray-600 dark:text-gray-400 cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-600" onclick="sortMetaTable(1, 'string')">
                            <div class="flex items-center justify-center gap-1">Type <span class="sort-icon">↕</span></div>
                        </th>
                        <th class="px-3 py-2 text-center text-xs font-semibold text-gray-600 dark:text-gray-400 cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-600" onclick="sortMetaTable(2, 'number')">
                            <div class="flex items-center justify-center gap-1">LR <span class="sort-icon">↕</span></div>
                        </th>
                        <th class="px-3 py-2 text-center text-xs font-semibold text-gray-600 dark:text-gray-400 cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-600" onclick="sortMetaTable(3, 'number')">
                            <div class="flex items-center justify-center gap-1">LoRA r <span class="sort-icon">↕</span></div>
                        </th>
                        <th class="px-3 py-2 text-center text-xs font-semibold text-gray-600 dark:text-gray-400 cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-600" onclick="sortMetaTable(4, 'number')">
                            <div class="flex items-center justify-center gap-1">Final Loss <span class="sort-icon">↕</span></div>
                        </th>
                        <th class="px-3 py-2 text-center text-xs font-semibold text-gray-600 dark:text-gray-400 cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-600" onclick="sortMetaTable(5, 'number')">
                            <div class="flex items-center justify-center gap-1">ROUGE-L <span class="sort-icon">↕</span></div>
                        </th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-gray-100 dark:divide-gray-700">
                    {% for f in meta_features %}
                    <tr class="hover:bg-gray-50 dark:hover:bg-gray-700 meta-row"
                        data-type="{{ 'synthetic' if f.is_synthetic else 'real' }}"
                        data-lr="{{ f.learning_rate or '' }}"
                        data-lora="{{ f.lora_r or '' }}"
                        data-model="{{ f.model_name or '' }}"
                        data-batch="{{ f.batch_size or '' }}">
                        <td class="px-3 py-2 font-mono" data-value="{{ f.experiment_id }}">{{ f.experiment_id[:16] }}...</td>
                        <td class="px-3 py-2 text-center" data-value="{{ 'synthetic' if f.is_synthetic else 'real' }}">
                            {% if f.is_synthetic %}
                            <span class="badge badge-purple">synthetic</span>
                            {% else %}
                            <span class="badge badge-blue">real</span>
                            {% endif %}
                        </td>
                        <td class="px-3 py-2 text-center font-mono" data-value="{{ f.learning_rate or 0 }}">{{ "%.0e"|format(f.learning_rate) if f.learning_rate else '-' }}</td>
                        <td class="px-3 py-2 text-center" data-value="{{ f.lora_r or 0 }}">{{ f.lora_r or '-' }}</td>
                        <td class="px-3 py-2 text-center font-mono text-amber-600 dark:text-amber-400" data-value="{{ f.final_eval_loss or 999 }}">{{ "%.4f"|format(f.final_eval_loss) if f.final_eval_loss else '-' }}</td>
                        <td class="px-3 py-2 text-center font-mono text-emerald-600 dark:text-emerald-400" data-value="{{ f.final_rouge_score if f.final_rouge_score and f.final_rouge_score > 0 else (f.final_bleu_score or -1) }}">
                            {% if f.final_rouge_score and f.final_rouge_score > 0 %}
                            {{ "%.2f"|format(f.final_rouge_score) }}
                            {% elif f.final_bleu_score and f.final_bleu_score > 0 %}
                            <span class="text-blue-500" title="BLEU (no ROUGE available)">{{ "%.2f"|format(f.final_bleu_score) }}*</span>
                            {% else %}
                            -
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        <p id="meta-count" class="text-sm text-gray-500 dark:text-gray-400 mt-4 text-center">Showing {{ meta_features | length }} features</p>
        {% else %}
        <p class="text-gray-500 dark:text-gray-400 text-center py-8">No meta-features stored yet. Generate synthetic data or extract from experiments.</p>
        {% endif %}
    </div>
</div>

<script>
// Populate filter dropdowns from table data
document.addEventListener('DOMContentLoaded', function() {
    const rows = document.querySelectorAll('.meta-row');
    const lrValues = new Set();
    const loraValues = new Set();
    const modelValues = new Set();
    const batchValues = new Set();
    
    rows.forEach(row => {
        if (row.dataset.lr) lrValues.add(row.dataset.lr);
        if (row.dataset.lora) loraValues.add(row.dataset.lora);
        if (row.dataset.model) modelValues.add(row.dataset.model);
        if (row.dataset.batch) batchValues.add(row.dataset.batch);
    });
    
    populateSelect('filter-lr', Array.from(lrValues).sort((a, b) => parseFloat(a) - parseFloat(b)), v => parseFloat(v).toExponential(0));
    populateSelect('filter-lora', Array.from(loraValues).sort((a, b) => parseInt(a) - parseInt(b)));
    populateSelect('filter-model', Array.from(modelValues).sort(), v => v.split('/').pop());
    populateSelect('filter-batch', Array.from(batchValues).sort((a, b) => parseInt(a) - parseInt(b)));
});

function populateSelect(id, values, labelFn) {
    const select = document.getElementById(id);
    if (!select) return;
    values.forEach(v => {
        const opt = document.createElement('option');
        opt.value = v;
        opt.textContent = labelFn ? labelFn(v) : v;
        select.appendChild(opt);
    });
}

function applyMetaFilters() {
    const typeFilter = document.getElementById('filter-type').value;
    const lrFilter = document.getElementById('filter-lr').value;
    const loraFilter = document.getElementById('filter-lora').value;
    const modelFilter = document.getElementById('filter-model').value;
    const batchFilter = document.getElementById('filter-batch').value;
    
    const rows = document.querySelectorAll('.meta-row');
    let visibleCount = 0;
    
    rows.forEach(row => {
        let match = true;
        if (typeFilter && row.dataset.type !== typeFilter) match = false;
        if (lrFilter && row.dataset.lr !== lrFilter) match = false;
        if (loraFilter && row.dataset.lora !== loraFilter) match = false;
        if (modelFilter && row.dataset.model !== modelFilter) match = false;
        if (batchFilter && row.dataset.batch !== batchFilter) match = false;
        
        row.style.display = match ? '' : 'none';
        if (match) visibleCount++;
    });
    
    document.getElementById('meta-count').textContent = `Showing ${visibleCount} of {{ meta_features | length }} features`;
}

let metaSortColumn = -1;
let metaSortAsc = true;

function sortMetaTable(colIndex, type) {
    const table = document.getElementById('meta-features-table');
    const tbody = table.querySelector('tbody');
    const rows = Array.from(tbody.querySelectorAll('tr'));
    
    if (metaSortColumn === colIndex) {
        metaSortAsc = !metaSortAsc;
    } else {
        metaSortColumn = colIndex;
        metaSortAsc = true;
    }
    
    rows.sort((a, b) => {
        const aCell = a.cells[colIndex];
        const bCell = b.cells[colIndex];
        let aVal = aCell.dataset.value || aCell.textContent.trim();
        let bVal = bCell.dataset.value || bCell.textContent.trim();
        
        if (type === 'number') {
            aVal = parseFloat(aVal) || 0;
            bVal = parseFloat(bVal) || 0;
            return metaSortAsc ? aVal - bVal : bVal - aVal;
        } else {
            return metaSortAsc ? aVal.localeCompare(bVal) : bVal.localeCompare(aVal);
        }
    });
    
    rows.forEach(row => tbody.appendChild(row));
    
    // Update sort icons
    const headers = table.querySelectorAll('th');
    headers.forEach((th, i) => {
        const icon = th.querySelector('.sort-icon');
        if (icon) {
            if (i === colIndex) {
                icon.textContent = metaSortAsc ? '↑' : '↓';
            } else {
                icon.textContent = '↕';
            }
        }
    });
}
</script>
{% endblock %}

