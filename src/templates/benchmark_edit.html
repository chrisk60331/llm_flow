{% extends "base.html" %}

{% block title %}Edit Benchmark - {{ benchmark.name }}{% endblock %}

{% block content %}
<div class="max-w-2xl mx-auto">
    <div class="mb-6">
        <h1 class="text-2xl font-bold text-gray-900 dark:text-gray-100">Edit Benchmark</h1>
        <p class="text-gray-600 dark:text-gray-400">Update benchmark settings and inference parameters</p>
    </div>

    <div class="card">
        <div class="card-header">
            <h2 class="font-semibold text-gray-800 dark:text-gray-200">Benchmark Settings</h2>
        </div>
        <div class="card-body">
            <form action="/benchmarks/{{ benchmark.id }}/edit" method="post" class="space-y-4">
                <input type="hidden" name="benchmark_type" value="{{ benchmark.benchmark_type }}" />
                <div class="form-group">
                    <label class="form-label">Benchmark Type</label>
                    <input type="text" class="form-input" value="{{ benchmark.benchmark_type }}" disabled />
                </div>
                <div class="form-group">
                    <label class="form-label">Benchmark Name</label>
                    <input type="text" name="name" required class="form-input" value="{{ benchmark.name }}">
                </div>
                <div class="form-group">
                    <label class="form-label">Question</label>
                    <textarea id="question" name="question" rows="3" class="form-textarea">{{ benchmark.question }}</textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">Gold Answer</label>
                    <textarea id="gold_answer" name="gold_answer" rows="3" class="form-textarea">{{ benchmark.gold_answer }}</textarea>
                </div>
                
                <div id="spec_section" class="section-card hidden">
                    <div class="section-header">
                        <h3 class="section-title">Spec (JSON)</h3>
                    </div>
                    <div class="section-body">
                        <textarea id="spec_json" name="spec_json" rows="5" class="form-textarea" spellcheck="false">{{ (benchmark.spec or {}) | tojson }}</textarea>
                        <p class="text-xs text-gray-500 mt-2">Type-specific settings.</p>
                    </div>
                </div>

                <div id="inference_section" class="section-card">
                    <div class="section-header">
                        <h3 class="section-title">Inference Settings</h3>
                    </div>
                    <div class="section-body">
                        <p class="text-sm text-gray-600 dark:text-gray-400 mb-4">
                            These settings control how the model generates responses during evaluation.
                        </p>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div class="form-group">
                                <label class="form-label">Max Response Tokens</label>
                                <input type="number" name="max_new_tokens" value="{{ benchmark.max_new_tokens }}" min="1" max="4096" class="form-input">
                                <p class="text-xs text-gray-500 mt-1">Maximum tokens to generate</p>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Temperature</label>
                                <input type="number" name="temperature" value="{{ benchmark.temperature }}" min="0.01" max="2.0" step="0.1" class="form-input">
                                <p class="text-xs text-gray-500 mt-1">Sampling temperature (0.1-2.0)</p>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Top-P</label>
                                <input type="number" name="top_p" value="{{ benchmark.top_p }}" min="0.01" max="1.0" step="0.05" class="form-input">
                                <p class="text-xs text-gray-500 mt-1">Nucleus sampling (0.1-1.0)</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="scoring_section" class="section-card hidden">
                    <div class="section-header">
                        <h3 class="section-title">Scoring</h3>
                    </div>
                    <div class="section-body">
                        <div class="form-group">
                            <label class="inline-flex items-center gap-2">
                                <input id="higher_is_better" name="higher_is_better" type="checkbox" class="form-checkbox" {% if benchmark.higher_is_better %}checked{% endif %}>
                                <span class="text-sm text-gray-900 dark:text-gray-100">Higher is better</span>
                            </label>
                            <p class="text-xs text-gray-500 mt-1">
                                Only applies to <span class="font-mono">custom_lightning_plugin</span> benchmarks (controls ranking for <span class="font-mono">primary_score</span>).
                            </p>
                        </div>
                    </div>
                </div>
                
                <div class="flex justify-end gap-3 pt-4">
                    <a href="/benchmarks" class="px-4 py-2 text-gray-700 dark:text-gray-300 font-medium hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg transition-all">Cancel</a>
                    <button type="submit" class="btn-primary">Save Changes</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
  const benchmarkType = "{{ benchmark.benchmark_type }}";
  const question = document.getElementById('question');
  const gold = document.getElementById('gold_answer');
  const specSection = document.getElementById('spec_section');
  const inferenceSection = document.getElementById('inference_section');
  const scoringSection = document.getElementById('scoring_section');
  const higherIsBetter = document.getElementById('higher_is_better');

  function applyTypeUI() {
    question.required = true;
    gold.required = true;
    specSection.classList.add('hidden');
    inferenceSection.classList.remove('hidden');
    scoringSection.classList.add('hidden');
    if (higherIsBetter) higherIsBetter.disabled = true;

    if (benchmarkType === 'causal_lm_qa') {
      return;
    }
    if (benchmarkType === 'masked_lm_fill_mask') {
      inferenceSection.classList.add('hidden');
      return;
    }
    // custom lightning benchmarks
    inferenceSection.classList.add('hidden');
    specSection.classList.remove('hidden');
    question.required = false;
    gold.required = false;
    if (benchmarkType === 'custom_lightning_plugin') {
      scoringSection.classList.remove('hidden');
      if (higherIsBetter) higherIsBetter.disabled = false;
    }
  }

  applyTypeUI();
</script>
{% endblock %}

