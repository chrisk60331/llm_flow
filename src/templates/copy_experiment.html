{% extends "base.html" %}

{% block title %}Copy Experiment{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto">
    <div class="mb-6">
        <div class="flex items-center gap-3 mb-2">
            {% if experiment.experiment_type == 'causal_lm' %}
            <span class="badge badge-green">Causal LM</span>
            {% elif experiment.experiment_type == 'masked_lm' %}
            <span class="badge badge-blue">Masked LM</span>
            {% elif experiment.experiment_type == 'custom_lightning' %}
            <span class="badge badge-purple">Custom Lightning</span>
            {% endif %}
            <h1 class="text-2xl font-bold text-gray-900 dark:text-gray-100">Copy & Edit Experiment</h1>
        </div>
        <p class="text-gray-600 dark:text-gray-400">Create a new experiment based on {{ experiment.id[:8] }}...</p>
    </div>
    
    {% if experiment.experiment_type == 'custom_lightning' %}
    <form action="/experiments/custom-lightning" method="post" class="space-y-6">
        <!-- Dataset Selection -->
        <div class="section-card">
            <div class="section-header">
                <svg class="w-5 h-5 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 7v10c0 2.21 3.582 4 8 4s8-1.79 8-4V7M4 7c0 2.21 3.582 4 8 4s8-1.79 8-4M4 7c0-2.21 3.582-4 8-4s8 1.79 8 4"></path></svg>
                <h2 class="section-title">Dataset</h2>
            </div>
            <div class="section-body">
                <select name="dataset_id" class="form-select" required>
                    {% for ds in datasets %}
                    <option value="{{ ds.id }}" {% if ds.id == experiment.dataset_id %}selected{% endif %}>{{ ds.filename }} ({{ ds.row_count }} rows)</option>
                    {% endfor %}
                </select>
            </div>
        </div>

        <div class="section-card">
            <div class="section-header">
                <svg class="w-5 h-5 text-purple-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path></svg>
                <h2 class="section-title">LightningModule + DataLoaders</h2>
            </div>
            <div class="section-body space-y-4">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="form-group">
                        <label class="form-label">LightningModule plugin</label>
                        <select id="lm_plugin_id" name="lightning_module_plugin_id" class="form-select" required>
                            {% for p in lightning_plugins %}
                            <option value="{{ p.id }}" {% if p.id == experiment.lightning_module_plugin_id %}selected{% endif %}>{{ p.name }} ({{ p.filename }})</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">LightningModule class</label>
                        <select id="lm_class_name" name="lightning_module_class_name" class="form-select" required></select>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="form-group">
                        <label class="form-label">Dataloaders plugin</label>
                        <select name="dataloaders_plugin_id" class="form-select" required>
                            {% for p in dataloader_plugins %}
                            <option value="{{ p.id }}" {% if p.id == experiment.dataloaders_plugin_id %}selected{% endif %}>{{ p.name }} ({{ p.filename }})</option>
                            {% endfor %}
                        </select>
                        <input type="hidden" name="dataloaders_function_name" value="build_dataloaders" />
                    </div>
                    <div class="form-group">
                        <label class="form-label">cfg (JSON)</label>
                        <textarea name="cfg_json" rows="6" class="form-textarea font-mono text-sm" spellcheck="false" required>{{ (experiment.config.cfg or {}) | tojson(indent=2) }}</textarea>
                    </div>
                </div>
            </div>
        </div>

        <div class="section-card">
            <div class="section-header">
                <svg class="w-5 h-5 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>
                <h2 class="section-title">Training</h2>
            </div>
            <div class="section-body">
                <div class="grid grid-cols-2 md:grid-cols-5 gap-4">
                    <div class="form-group">
                        <label class="form-label">max_epochs</label>
                        <input type="number" name="max_epochs" min="1" value="{{ experiment.config.training.max_epochs }}" class="form-input">
                    </div>
                    <div class="form-group">
                        <label class="form-label">accelerator</label>
                        <input type="text" name="accelerator" value="{{ experiment.config.training.accelerator }}" class="form-input">
                    </div>
                    <div class="form-group">
                        <label class="form-label">devices</label>
                        <input type="text" name="devices" value="{{ experiment.config.training.devices }}" class="form-input">
                    </div>
                    <div class="form-group">
                        <label class="form-label">precision</label>
                        <input type="text" name="precision" value="{{ experiment.config.training.precision }}" class="form-input">
                    </div>
                    <div class="form-group">
                        <label class="form-label">log_every_n_steps</label>
                        <input type="number" name="log_every_n_steps" min="1" value="{{ experiment.config.training.log_every_n_steps }}" class="form-input">
                    </div>
                </div>
            </div>
        </div>

        <div class="flex items-center justify-end gap-4">
            <a href="/experiments/{{ experiment.id }}" class="text-sm font-medium text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-white">Cancel</a>
            <button type="submit" class="btn-success flex items-center gap-2">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>
                Start Training
            </button>
        </div>
    </form>

    <script>
      const pluginData = {{ lightning_plugin_classes | tojson }};
      const pluginSelect = document.getElementById('lm_plugin_id');
      const classSelect = document.getElementById('lm_class_name');
      const selectedClass = {{ (experiment.lightning_module_class_name or '') | tojson }};

      function populateClasses() {
        const pid = pluginSelect.value;
        const classes = (pluginData[pid] || []);
        classSelect.innerHTML = '';
        classes.forEach((c) => {
          const opt = document.createElement('option');
          opt.value = c;
          opt.textContent = c;
          if (c === selectedClass) opt.selected = true;
          classSelect.appendChild(opt);
        });
      }

      pluginSelect.addEventListener('change', populateClasses);
      populateClasses();
    </script>
    {% else %}
    <form action="/experiments/{{ 'causal-lm' if experiment.experiment_type == 'causal_lm' else 'masked-lm' }}" method="post" class="space-y-6">
        <!-- Dataset Selection -->
        <div class="section-card">
            <div class="section-header">
                <svg class="w-5 h-5 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 7v10c0 2.21 3.582 4 8 4s8-1.79 8-4V7M4 7c0 2.21 3.582 4 8 4s8-1.79 8-4M4 7c0-2.21 3.582-4 8-4s8 1.79 8 4"></path></svg>
                <h2 class="section-title">Dataset</h2>
            </div>
            <div class="section-body">
                <select name="dataset_id" class="form-select" required>
                    {% for ds in datasets %}
                    <option value="{{ ds.id }}" {% if ds.id == experiment.dataset_id %}selected{% endif %}>{{ ds.filename }} ({{ ds.row_count }} rows)</option>
                    {% endfor %}
                </select>
            </div>
        </div>
        
        {% if experiment.experiment_type == 'causal_lm' %}
        <!-- ===================== CAUSAL LM CONFIG ===================== -->
        
        <!-- Data Configuration -->
        <div class="section-card">
            <div class="section-header">
                <svg class="w-5 h-5 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 7v10c0 2.21 3.582 4 8 4s8-1.79 8-4V7M4 7c0 2.21 3.582 4 8 4s8-1.79 8-4M4 7c0-2.21 3.582-4 8-4s8 1.79 8 4"></path></svg>
                <h2 class="section-title">Data Configuration</h2>
            </div>
            <div class="section-body space-y-4">
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                    <div class="form-group">
                        <label class="form-label">Question Field</label>
                        <input type="text" name="question_field" value="{{ experiment.config.data.question_field }}" class="form-input">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Answer Field</label>
                        <input type="text" name="answer_field" value="{{ experiment.config.data.answer_field }}" class="form-input">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Max Length</label>
                        <input type="number" name="max_length" value="{{ experiment.config.data.max_length }}" class="form-input">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Validation Split</label>
                        <input type="number" name="validation_split" value="{{ experiment.config.data.validation_split }}" step="0.05" class="form-input">
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">System Prompt</label>
                    <textarea name="system_prompt" rows="2" class="form-textarea">{{ experiment.config.data.system_prompt }}</textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">Template <span class="text-xs text-gray-400">(use {system_prompt}, {question}, {answer})</span></label>
                    <textarea name="template" rows="4" class="form-textarea font-mono text-sm">{{ experiment.config.data.template }}</textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">Seed</label>
                    <input type="number" name="seed" value="{{ experiment.config.data.seed }}" class="form-input w-32">
                </div>
            </div>
        </div>
        
        <!-- Model Configuration -->
        <div class="section-card">
            <div class="section-header">
                <svg class="w-5 h-5 text-purple-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path></svg>
                <h2 class="section-title">Model Configuration</h2>
            </div>
            <div class="section-body">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="form-group">
                        <label class="form-label">Pretrained Model</label>
                        <input type="text" name="pretrained_model_name" value="{{ experiment.config.model.pretrained_model_name }}" class="form-input font-mono">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Pad Token Override</label>
                        <input type="text" name="pad_token_override" value="{{ experiment.config.model.pad_token_override or '' }}" class="form-input font-mono">
                    </div>
                </div>
                <div class="flex items-center gap-4 mt-4">
                    <div class="flex items-center gap-2">
                        <input type="checkbox" name="trust_remote_code" id="trust_remote_code" class="form-checkbox" {% if experiment.config.model.trust_remote_code %}checked{% endif %}>
                        <label for="trust_remote_code" class="text-sm text-gray-700 dark:text-gray-300">Trust Remote Code</label>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- PEFT / LoRA Configuration -->
        <div class="section-card">
            <div class="section-header">
                <svg class="w-5 h-5 text-amber-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4"></path></svg>
                <h2 class="section-title">PEFT / LoRA Configuration</h2>
            </div>
            <div class="section-body">
                <div class="flex items-center gap-3 mb-4">
                    <input type="checkbox" name="peft_enabled" id="peft_enabled" class="form-checkbox" {% if experiment.config.peft.enabled %}checked{% endif %}>
                    <label for="peft_enabled" class="text-sm text-gray-700 dark:text-gray-300">Enable PEFT/LoRA</label>
                </div>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                    <div class="form-group">
                        <label class="form-label">LoRA Rank (r)</label>
                        <input type="number" name="peft_r" value="{{ experiment.config.peft.r }}" class="form-input">
                    </div>
                    <div class="form-group">
                        <label class="form-label">LoRA Alpha</label>
                        <input type="number" name="peft_lora_alpha" value="{{ experiment.config.peft.lora_alpha }}" class="form-input">
                    </div>
                    <div class="form-group">
                        <label class="form-label">LoRA Dropout</label>
                        <input type="number" name="peft_lora_dropout" value="{{ experiment.config.peft.lora_dropout }}" step="0.01" class="form-input">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Bias</label>
                        <select name="peft_bias" class="form-select">
                            <option value="none" {% if experiment.config.peft.bias == 'none' %}selected{% endif %}>none</option>
                            <option value="lora_only" {% if experiment.config.peft.bias == 'lora_only' %}selected{% endif %}>lora_only</option>
                            <option value="all" {% if experiment.config.peft.bias == 'all' %}selected{% endif %}>all</option>
                        </select>
                    </div>
                </div>
                <div class="form-group mt-4">
                    <label class="form-label">Target Modules (comma-separated)</label>
                    <input type="text" name="peft_target_modules" value="{{ experiment.config.peft.target_modules | join(',') }}" class="form-input font-mono">
                </div>
            </div>
        </div>
        
        <!-- Training Configuration -->
        <div class="section-card">
            <div class="section-header">
                <svg class="w-5 h-5 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>
                <h2 class="section-title">Training Configuration</h2>
            </div>
            <div class="section-body space-y-4">
                <!-- Core Training Params -->
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                    <div class="form-group">
                        <label class="form-label">Epochs</label>
                        <input type="number" name="num_train_epochs" value="{{ experiment.config.training.num_train_epochs }}" step="0.5" class="form-input">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Max Steps</label>
                        <input type="number" name="max_steps" value="{{ experiment.config.training.max_steps }}" class="form-input">
                        <p class="text-xs text-gray-400 mt-1">-1 = use epochs</p>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Learning Rate</label>
                        <input type="text" name="learning_rate" value="{{ experiment.config.training.learning_rate }}" class="form-input font-mono">
                    </div>
                    <div class="form-group">
                        <label class="form-label">LR Scheduler</label>
                        <select name="lr_scheduler_type" class="form-select">
                            <option value="cosine" {% if experiment.config.training.lr_scheduler_type == 'cosine' %}selected{% endif %}>cosine</option>
                            <option value="linear" {% if experiment.config.training.lr_scheduler_type == 'linear' %}selected{% endif %}>linear</option>
                            <option value="constant" {% if experiment.config.training.lr_scheduler_type == 'constant' %}selected{% endif %}>constant</option>
                            <option value="constant_with_warmup" {% if experiment.config.training.lr_scheduler_type == 'constant_with_warmup' %}selected{% endif %}>constant_with_warmup</option>
                        </select>
                    </div>
                </div>
                
                <!-- Batch & Memory -->
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                    <div class="form-group">
                        <label class="form-label">Train Batch Size</label>
                        <input type="number" name="per_device_train_batch_size" value="{{ experiment.config.training.per_device_train_batch_size }}" class="form-input">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Eval Batch Size</label>
                        <input type="number" name="per_device_eval_batch_size" value="{{ experiment.config.training.per_device_eval_batch_size }}" class="form-input">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Gradient Accumulation</label>
                        <input type="number" name="gradient_accumulation_steps" value="{{ experiment.config.training.gradient_accumulation_steps }}" class="form-input">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Warmup Ratio</label>
                        <input type="number" name="warmup_ratio" value="{{ experiment.config.training.warmup_ratio }}" step="0.01" class="form-input">
                    </div>
                </div>
                
                <!-- Regularization -->
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                    <div class="form-group">
                        <label class="form-label">Weight Decay</label>
                        <input type="number" name="weight_decay" value="{{ experiment.config.training.weight_decay }}" step="0.001" class="form-input">
                    </div>
                </div>
                
                <!-- Logging & Checkpoints -->
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                    <div class="form-group">
                        <label class="form-label">Logging Steps</label>
                        <input type="number" name="logging_steps" value="{{ experiment.config.training.logging_steps }}" class="form-input">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Eval Steps</label>
                        <input type="number" name="eval_steps" value="{{ experiment.config.training.eval_steps }}" class="form-input">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Save Steps</label>
                        <input type="number" name="save_steps" value="{{ experiment.config.training.save_steps }}" class="form-input">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Save Total Limit</label>
                        <input type="number" name="save_total_limit" value="{{ experiment.config.training.save_total_limit }}" class="form-input">
                    </div>
                </div>
                
                <!-- Early Stopping -->
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                    <div class="form-group">
                        <label class="form-label">Early Stop Patience</label>
                        <input type="number" name="early_stopping_patience" value="{{ experiment.config.training.early_stopping_patience or '' }}" placeholder="None" class="form-input">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Early Stop Metric</label>
                        <input type="text" name="early_stopping_metric" value="{{ experiment.config.training.early_stopping_metric }}" class="form-input">
                    </div>
                </div>
                
                <!-- Flags -->
                <div class="flex flex-wrap items-center gap-6 pt-2">
                    <div class="flex items-center gap-2">
                        <input type="checkbox" name="gradient_checkpointing" id="gradient_checkpointing" class="form-checkbox" {% if experiment.config.training.gradient_checkpointing %}checked{% endif %}>
                        <label for="gradient_checkpointing" class="text-sm text-gray-700 dark:text-gray-300">Gradient Checkpointing</label>
                    </div>
                    <div class="flex items-center gap-2">
                        <input type="checkbox" name="fp16" id="fp16" class="form-checkbox" {% if experiment.config.training.fp16 %}checked{% endif %}>
                        <label for="fp16" class="text-sm text-gray-700 dark:text-gray-300">FP16</label>
                    </div>
                    <div class="flex items-center gap-2">
                        <input type="checkbox" name="bf16" id="bf16" class="form-checkbox" {% if experiment.config.training.bf16 %}checked{% endif %}>
                        <label for="bf16" class="text-sm text-gray-700 dark:text-gray-300">BF16</label>
                    </div>
                    <div class="flex items-center gap-2">
                        <input type="checkbox" name="auto_evaluate" id="auto_evaluate" class="form-checkbox" {% if experiment.config.training.auto_evaluate %}checked{% endif %}>
                        <label for="auto_evaluate" class="text-sm text-gray-700 dark:text-gray-300">Auto-Evaluate on Completion</label>
                    </div>
                </div>
            </div>
        </div>
        
        {% else %}
        <!-- ===================== MASKED LM CONFIG ===================== -->
        
        <!-- Data Configuration -->
        <div class="section-card">
            <div class="section-header">
                <svg class="w-5 h-5 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 7v10c0 2.21 3.582 4 8 4s8-1.79 8-4V7M4 7c0 2.21 3.582 4 8 4s8-1.79 8-4M4 7c0-2.21 3.582-4 8-4s8 1.79 8 4"></path></svg>
                <h2 class="section-title">Data Configuration</h2>
            </div>
            <div class="section-body">
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                    <div class="form-group col-span-2">
                        <label class="form-label">Text Fields (comma-separated)</label>
                        <input type="text" name="text_fields" value="{{ experiment.config.data.text_fields | join(',') }}" class="form-input">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Separator</label>
                        <input type="text" name="separator" value="{{ experiment.config.data.separator | replace('\n', '\\n') }}" class="form-input font-mono">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Max Length</label>
                        <input type="number" name="max_length" value="{{ experiment.config.data.max_length }}" class="form-input">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Validation Split</label>
                        <input type="number" name="validation_split" value="{{ experiment.config.data.validation_split }}" step="0.05" class="form-input">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Seed</label>
                        <input type="number" name="seed" value="{{ experiment.config.data.seed }}" class="form-input">
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Model Configuration -->
        <div class="section-card">
            <div class="section-header">
                <svg class="w-5 h-5 text-purple-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path></svg>
                <h2 class="section-title">Model Configuration</h2>
            </div>
            <div class="section-body">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div class="form-group">
                        <label class="form-label">Pretrained Model</label>
                        <input type="text" name="pretrained_model_name" value="{{ experiment.config.model.pretrained_model_name }}" class="form-input font-mono">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Freeze Encoder Layers</label>
                        <input type="number" name="freeze_encoder_layers" value="{{ experiment.config.model.freeze_encoder_layers }}" min="0" max="12" class="form-input">
                    </div>
                    <div class="form-group flex items-end pb-2">
                        <div class="flex items-center gap-2">
                            <input type="checkbox" name="freeze_embedding" id="freeze_embedding" class="form-checkbox" {% if experiment.config.model.freeze_embedding %}checked{% endif %}>
                            <label for="freeze_embedding" class="text-sm text-gray-700 dark:text-gray-300">Freeze Embeddings</label>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Training Configuration -->
        <div class="section-card">
            <div class="section-header">
                <svg class="w-5 h-5 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>
                <h2 class="section-title">Training Configuration</h2>
            </div>
            <div class="section-body space-y-4">
                <!-- Core Training Params -->
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                    <div class="form-group">
                        <label class="form-label">Epochs</label>
                        <input type="number" name="num_train_epochs" value="{{ experiment.config.training.num_train_epochs }}" step="0.5" class="form-input">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Max Steps</label>
                        <input type="number" name="max_steps" value="{{ experiment.config.training.max_steps }}" class="form-input">
                        <p class="text-xs text-gray-400 mt-1">-1 = use epochs</p>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Learning Rate</label>
                        <input type="text" name="learning_rate" value="{{ experiment.config.training.learning_rate }}" class="form-input font-mono">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Weight Decay</label>
                        <input type="number" name="weight_decay" value="{{ experiment.config.training.weight_decay }}" step="0.001" class="form-input">
                    </div>
                </div>
                
                <!-- Batch & Memory -->
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                    <div class="form-group">
                        <label class="form-label">Train Batch Size</label>
                        <input type="number" name="per_device_train_batch_size" value="{{ experiment.config.training.per_device_train_batch_size }}" class="form-input">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Eval Batch Size</label>
                        <input type="number" name="per_device_eval_batch_size" value="{{ experiment.config.training.per_device_eval_batch_size }}" class="form-input">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Gradient Accumulation</label>
                        <input type="number" name="gradient_accumulation_steps" value="{{ experiment.config.training.gradient_accumulation_steps }}" class="form-input">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Warmup Ratio</label>
                        <input type="number" name="warmup_ratio" value="{{ experiment.config.training.warmup_ratio }}" step="0.01" class="form-input">
                    </div>
                </div>
                
                <!-- Logging & Checkpoints -->
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                    <div class="form-group">
                        <label class="form-label">Logging Steps</label>
                        <input type="number" name="logging_steps" value="{{ experiment.config.training.logging_steps }}" class="form-input">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Eval Steps</label>
                        <input type="number" name="eval_steps" value="{{ experiment.config.training.eval_steps }}" class="form-input">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Save Steps</label>
                        <input type="number" name="save_steps" value="{{ experiment.config.training.save_steps }}" class="form-input">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Save Total Limit</label>
                        <input type="number" name="save_total_limit" value="{{ experiment.config.training.save_total_limit }}" class="form-input">
                    </div>
                </div>
                
                <!-- Early Stopping -->
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                    <div class="form-group">
                        <label class="form-label">Early Stop Patience</label>
                        <input type="number" name="early_stopping_patience" value="{{ experiment.config.training.early_stopping_patience or '' }}" placeholder="None" class="form-input">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Early Stop Metric</label>
                        <input type="text" name="early_stopping_metric" value="{{ experiment.config.training.early_stopping_metric }}" class="form-input">
                    </div>
                </div>
                
                <!-- Flags -->
                <div class="flex flex-wrap items-center gap-6 pt-2">
                    <div class="flex items-center gap-2">
                        <input type="checkbox" name="auto_evaluate" id="auto_evaluate" class="form-checkbox" {% if experiment.config.training.auto_evaluate %}checked{% endif %}>
                        <label for="auto_evaluate" class="text-sm text-gray-700 dark:text-gray-300">Auto-Evaluate on Completion</label>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}
        
        <!-- Submit -->
        <div class="flex items-center justify-end gap-4">
            <a href="/experiments/{{ experiment.id }}" class="text-sm font-medium text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-white">Cancel</a>
            <button type="submit" class="btn-success flex items-center gap-2">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>
                Start Training
            </button>
        </div>
    </form>
    {% endif %}
</div>
{% endblock %}
